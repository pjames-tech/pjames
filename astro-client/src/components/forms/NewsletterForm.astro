---
// Newsletter subscription form
---

<div class="text-center">
  <h3 class="font-display font-bold text-[var(--step-1)]">
    The AI-Growth Newsletter
  </h3>
  <p class="mt-2 text-sm text-muted">Weekly notes on what's working.</p>
  
  <form id="newsletter-form" class="mt-4 space-y-3">
    <input
      id="newsletter-email"
      name="email"
      type="email"
      autocomplete="email"
      placeholder="you@company.com"
      class="w-full rounded-pill bg-panel soft-border px-4 py-3 outline-none focus:shadow-glow text-center"
      required
    />
    <button
      type="submit"
      class="w-full rounded-pill px-5 py-3 font-medium text-[rgb(var(--bg))] btn-primary shadow-[0_0_15px_rgb(var(--accent)/0.3)] hover:scale-[1.02] hover:shadow-[0_0_30px_rgb(var(--accent)/0.5)] transition duration-300"
    >
      Subscribe
    </button>
    <p id="newsletter-status" class="text-sm text-[rgb(var(--accent))] hidden"></p>
  </form>
</div>

<script>
  const initNewsletterForm = () => {
    const form = document.getElementById("newsletter-form") as HTMLFormElement;
    const status = document.getElementById("newsletter-status");

    if (!form || !status) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const data = {
        email: formData.get("email"),
        ts: new Date().toISOString(),
      };

      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      const originalText = submitBtn.textContent;
      submitBtn.textContent = "Subscribing...";
      submitBtn.disabled = true;

      try {
        const res = await fetch("/api/newsletter", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await res.json();
        
        status.textContent = result.message || "Thanks for subscribing! ðŸš€";
        status.classList.remove("hidden");
        
        if (result.isNew !== false) {
          form.reset();
        }
      } catch (err) {
        status.textContent = "Something went wrong. Try again later.";
        status.classList.remove("hidden");
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
  };

  document.addEventListener("DOMContentLoaded", initNewsletterForm);
  document.addEventListener("astro:page-load", initNewsletterForm);
</script>
