---
// Project Modal - dynamically populated by clicking project cards
---

<dialog
  id="project-modal"
  style="margin: auto;"
  class="w-[min(95vw,56rem)] rounded-[2rem] bg-[rgb(var(--panel))] soft-border p-0 backdrop:bg-black/85 backdrop:backdrop-blur-sm"
>
  <div class="relative max-h-[90vh] overflow-y-auto p-8 lg:p-12" data-lenis-prevent>
    <!-- Close Button -->
    <button
      id="project-modal-close"
      class="absolute top-6 right-6 p-2 rounded-full hover:bg-text/10 transition z-10"
      aria-label="Close project"
    >
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18M6 6l12 12" />
      </svg>
    </button>

    <!-- Main Image -->
    <div class="aspect-video w-full rounded-2xl overflow-hidden mb-6 bg-[rgb(var(--bg))]">
      <img
        id="project-modal-image"
        src=""
        alt=""
        class="h-full w-full object-cover"
      />
    </div>

    <!-- Category Badge -->
    <p
      id="project-modal-category"
      class="text-xs uppercase tracking-widest text-[rgb(var(--accent))] font-bold mb-2 text-center"
    ></p>

    <!-- Title -->
    <h3 id="project-modal-title" class="font-display font-bold text-[var(--step-2)] mb-4 text-center"></h3>

    <!-- Details -->
    <p id="project-modal-details" class="text-muted leading-relaxed mb-6 text-center max-w-2xl mx-auto"></p>

    <!-- Tools -->
    <div class="mb-6 text-center">
      <h4 class="text-sm uppercase tracking-widest text-muted font-medium mb-3">Built With</h4>
      <div id="project-modal-tools" class="flex flex-wrap justify-center gap-2"></div>
    </div>

    <!-- Gallery -->
    <div class="mb-6">
      <h4 class="text-sm uppercase tracking-widest text-muted font-medium mb-3 text-center">Gallery</h4>
      <div id="project-modal-gallery" class="grid grid-cols-4 gap-2"></div>
    </div>

    <!-- CTA - Always visible, centered -->
    <div class="text-center">
      <a
        id="project-modal-link"
        href="#"
        target="_blank"
        rel="noopener"
        class="inline-flex items-center gap-2 rounded-full px-8 py-4 font-bold btn-primary text-[rgb(var(--bg))]"
      >
        View Live Project
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3" />
        </svg>
      </a>
    </div>
  </div>
</dialog>

<script>
  const initProjectModal = () => {
    const modal = document.getElementById("project-modal") as HTMLDialogElement;
    const closeBtn = document.getElementById("project-modal-close");
    const projectCards = document.querySelectorAll(".project-card");

    if (!modal || !closeBtn) return;

    // Elements to populate
    const imgEl = document.getElementById("project-modal-image") as HTMLImageElement;
    const categoryEl = document.getElementById("project-modal-category");
    const titleEl = document.getElementById("project-modal-title");
    const detailsEl = document.getElementById("project-modal-details");
    const toolsEl = document.getElementById("project-modal-tools");
    const galleryEl = document.getElementById("project-modal-gallery");
    const linkEl = document.getElementById("project-modal-link") as HTMLAnchorElement;

    projectCards.forEach((card) => {
      card.addEventListener("click", () => {
        const data = card as HTMLElement;
        
        // Populate modal
        if (imgEl) {
          imgEl.src = data.dataset.image || "";
          imgEl.alt = data.dataset.title || "";
        }
        if (categoryEl) categoryEl.textContent = data.dataset.category || "";
        if (titleEl) titleEl.textContent = data.dataset.title || "";
        if (detailsEl) detailsEl.textContent = data.dataset.details || "";
        
        // Tools
        if (toolsEl) {
          toolsEl.innerHTML = "";
          const tools = (data.dataset.tools || "").split(",").filter(Boolean);
          tools.forEach((tool) => {
            const span = document.createElement("span");
            span.className = "px-3 py-1 rounded-full bg-white/10 text-sm text-muted";
            span.textContent = tool.trim();
            toolsEl.appendChild(span);
          });
        }

        // Gallery
        if (galleryEl) {
          galleryEl.innerHTML = "";
          const images = (data.dataset.gallery || "").split(",").filter(Boolean);
          images.forEach((src, i) => {
            const img = document.createElement("img");
            img.src = src.trim();
            img.alt = `${data.dataset.title} gallery ${i + 1}`;
            img.className = "rounded-lg aspect-video object-cover cursor-pointer hover:opacity-80 transition";
            img.addEventListener("click", () => {
              if (imgEl) imgEl.src = src.trim();
            });
            galleryEl.appendChild(img);
          });
        }

        // Link
        if (linkEl) {
          const link = data.dataset.link || "#";
          linkEl.href = link;
          linkEl.style.display = link === "#" ? "none" : "inline-flex";
        }

        modal.showModal();
      });
    });

    closeBtn.addEventListener("click", () => modal.close());
    
    modal.addEventListener("click", (e) => {
      if (e.target === modal) modal.close();
    });
  };

  document.addEventListener("DOMContentLoaded", initProjectModal);
  document.addEventListener("astro:page-load", initProjectModal);
</script>

<script>
  // Helper to manage Lenis state for Project Modal
  const modal = document.getElementById("project-modal");
  if (modal) {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'open') {
          const isOpen = (modal as HTMLDialogElement).open;
          if ((window as any).lenis) {
            isOpen ? (window as any).lenis.stop() : (window as any).lenis.start();
          }
          document.body.style.overflow = isOpen ? 'hidden' : '';
        }
      });
    });
    observer.observe(modal, { attributes: true });
  }
</script>
